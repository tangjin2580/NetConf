name: Build and Release Medical Network Tool

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  build-exe:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build executable
      run: |
        pyinstaller --clean --onefile --windowed `
          --hidden-import=config.settings `
          --hidden-import=core.network `
          --hidden-import=core.hosts `
          --hidden-import=core.system `
          --hidden-import=utils.cache `
          --hidden-import=utils.server `
          --add-data "config;config" `
          --add-data "core;core" `
          --add-data "utils;utils" `
          --name="åŒ»ä¿ç½‘ç»œé…ç½®å·¥å…·" `
          $(if (Test-Path "icon.ico") { "--icon=icon.ico" } else { "" }) `
          main.py

    - name: Build server executable (optional)
      run: |
        pyinstaller --clean --onefile `
          --name="åŒ»ä¿é…ç½®æœåŠ¡å™¨" `
          $(if (Test-Path "icon.ico") { "--icon=icon.ico" } else { "" }) `
          server.py
      continue-on-error: true

    - name: Get current version
      id: get_version
      shell: pwsh
      run: |
        # è·å–æ‰€æœ‰æ ‡ç­¾
        git fetch --tags
        $tags = git tag -l "v*.*.*" | Sort-Object { 
          [version]($_ -replace 'v','') 
        } -Descending
        
        if ($tags) {
          $latestTag = $tags[0]
          $version = $latestTag -replace 'v',''
          $parts = $version.Split('.')
          $major = [int]$parts[0]
          $minor = [int]$parts[1]
          $patch = [int]$parts[2] + 1
          $newVersion = "v$major.$minor.$patch"
        } else {
          $newVersion = "v1.0.0"
        }
        
        echo "new_version=$newVersion" >> $env:GITHUB_ENV
        echo "NEW_VERSION=$newVersion" >> $env:GITHUB_OUTPUT
        Write-Host "ç”Ÿæˆçš„æ–°ç‰ˆæœ¬å·: $newVersion"

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.NEW_VERSION }}
        release_name: åŒ»ä¿ç½‘ç»œé…ç½®å·¥å…· ${{ steps.get_version.outputs.NEW_VERSION }}
        body: |
          ## ğŸ‰ åŒ»ä¿ç½‘ç»œé…ç½®å·¥å…· ${{ steps.get_version.outputs.NEW_VERSION }}
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ” åŒ»ä¿ç½‘ç»œæ£€æµ‹ï¼ˆping + è¿é€šæ€§æµ‹è¯•ï¼‰
          - ğŸŒ åŒWANé…ç½®ï¼ˆè·¯ç”±å™¨æ¨¡å¼ï¼‰
          - ğŸ’» å•æœºé…ç½®ï¼ˆç›´è¿æ¨¡å¼ï¼‰
          - ğŸ§¾ Hostsæ–‡ä»¶ç®¡ç†
          - ğŸ“¡ é…ç½®ä¿¡æ¯æœåŠ¡å™¨ï¼ˆæ”¯æŒåœ¨çº¿ç¼–è¾‘ï¼‰
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **åŒ»ä¿ç½‘ç»œé…ç½®å·¥å…·.exe** - ä¸»ç¨‹åºï¼ˆéœ€ç®¡ç†å‘˜æƒé™è¿è¡Œï¼‰
          - **åŒ»ä¿é…ç½®æœåŠ¡å™¨.exe** - é…ç½®æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼Œé»˜è®¤ç«¯å£8080ï¼‰
          
          ### ğŸ“‹ ä½¿ç”¨è¦æ±‚
          - Windows 7/8/10/11
          - éœ€è¦ç®¡ç†å‘˜æƒé™
          - .NET Framework 4.5+ (é€šå¸¸ç³»ç»Ÿè‡ªå¸¦)
          
          ### ğŸ”§ æ›´æ–°å†…å®¹
          - æ¨¡å—åŒ–æ¶æ„é‡æ„
          - æ–°å¢åœ¨çº¿ç¼–è¾‘æ–‡æœ¬æ–‡ä»¶åŠŸèƒ½
          - ä¼˜åŒ–ç”¨æˆ·ç•Œé¢å’Œä½“éªŒ
          - å®Œå–„åŒ»ä¿ç½‘ç»œæ£€æµ‹åŠŸèƒ½
        draft: false
        prerelease: false

    - name: Upload Main Executable
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: dist/åŒ»ä¿ç½‘ç»œé…ç½®å·¥å…·.exe
        asset_name: åŒ»ä¿ç½‘ç»œé…ç½®å·¥å…·.exe
        asset_content_type: application/octet-stream

    - name: Upload Server Executable (optional)
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: dist/åŒ»ä¿é…ç½®æœåŠ¡å™¨.exe
        asset_name: åŒ»ä¿é…ç½®æœåŠ¡å™¨.exe
        asset_content_type: application/octet-stream
      continue-on-error: true

    - name: Upload artifacts for debugging
      uses: actions/upload-artifact@v4
      with:
        name: executables
        path: dist/*.exe
        retention-days: 7
